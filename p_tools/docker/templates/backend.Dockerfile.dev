FROM python:3.10-slim

WORKDIR /app

# Install curl for healthcheck and system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    libpq-dev \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Accept build arguments
ARG EXTRA_PACKAGES=""

# Install Python dependencies first to leverage Docker cache
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional packages if specified
RUN if [ -n "$EXTRA_PACKAGES" ]; then pip install --no-cache-dir $EXTRA_PACKAGES; fi

# Install development tools and monitoring utilities
RUN pip install --no-cache-dir \
    pytest \
    pytest-cov \
    black \
    isort \
    flake8 \
    psutil \
    pydantic-settings \
    httpx

# Ensure environment variables have default values
ENV SETUP_INVITATION_SYSTEM=false \
    DEBUG=true \
    DEBUG_MODE=true \
    LOG_LEVEL=debug \
    ENVIRONMENT=development \
    APP_ENVIRONMENT=development \
    DB_SSL_REQUIRED=false

# Create directory for init scripts
RUN mkdir -p /app/db/init

# Expose API port
EXPOSE 8000

# Create a health check script
COPY ./scripts/healthcheck.py /app/scripts/healthcheck.py
RUN chmod +x /app/scripts/healthcheck.py

# Create an entrypoint script for proper initialization
RUN echo '#!/bin/bash\n\
echo "Starting TAP Integration Platform Backend"\n\
echo "Environment: $APP_ENVIRONMENT"\n\
\n\
# Check if database directory exists, create if not\n\
mkdir -p /app/data\n\
\n\
# Run startup script\n\
if [ -f "/app/startup.sh" ]; then\n\
  echo "Running startup script..."\n\
  chmod +x /app/startup.sh\n\
  bash /app/startup.sh\n\
fi\n\
\n\
# Start the server with hot reloading\n\
exec uvicorn main:app --host 0.0.0.0 --port 8000 --reload\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Create a simple health check script
RUN echo '#!/bin/bash\n\
curl -f http://localhost:8000/health || exit 1\n\
' > /app/healthcheck.sh && chmod +x /app/healthcheck.sh

# Use the entrypoint script to start the server
ENTRYPOINT ["/app/entrypoint.sh"]

# Add Docker healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 CMD [ "/app/healthcheck.sh" ]